<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>São Paulo | Clientes por Município</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
:root{
--panel:#ffffff;
--muted:#6b7280;
--text:#111827;
--brand:#1e3a8a;

  --c-none:#bdbdbd;
  --c-inactive:#c62828;
  --c-active:#2e7d32;

  --c-selected:#ff6f00;
}

html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
body{ overflow:hidden; background:#f3f4f6; }

/* APP GRID (2 colunas) */
.app{
  position:fixed;
  inset:16px;
  display:grid;
  grid-template-columns: 1fr 460px;
  gap:12px;
  box-sizing:border-box;
}

/* MAPA */
#map, .map { height:100%; width:100%; }
.map{
  border-radius:10px;
  overflow:hidden;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  border:1px solid rgba(17,24,39,.06);
  background:#fff;
}

/* CARD / PAINEL */
.card{
  background:var(--panel);
  border-radius:10px;
  box-shadow:0 10px 30px rgba(0,0,0,.18);
  border:1px solid rgba(17,24,39,.06);
}

.panel{
  display:flex;
  flex-direction:column;
  min-height:180px;
  overflow:hidden;
  pointer-events:auto;
}

.panel-head{
  padding:12px 14px;
  border-bottom:1px solid rgba(17,24,39,.08);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.panel-head .title{
  font-weight:900;
  color:#111827;
  font-size:13px;
}
.panel-head .sub{
  color:var(--muted);
  font-size:11px;
  margin-top:2px;
  line-height:1.25;
}

.panel-body{
  padding:12px 14px;
  overflow:auto;
  flex:1;
}

.section{ display:block; }

.divider{
  height:1px;
  background: rgba(17,24,39,.10);
  margin:12px 0;
}

.btn{
  padding:9px 10px;
  border-radius:8px;
  border:1px solid rgba(17,24,39,.12);
  background:#fff;
  cursor:pointer;
  font-size:12px;
  font-weight:800;
  color:#111827;
  user-select:none;
  line-height:1;
}
.btn.primary{
  background:var(--brand);
  border-color:var(--brand);
  color:#fff;
}
.btn.danger{
  background:#b91c1c;
  border-color:#b91c1c;
  color:#fff;
}
.btn:disabled{ opacity:.55; cursor:not-allowed; }

.btn.xs{
  padding:6px 12px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
}

.muted{ color:var(--muted); }

.search{
  display:flex; gap:8px;
  margin-bottom:10px;
}

input, .input{
  width:100%;
  padding:9px 10px;
  border-radius:8px;
  border:1px solid rgba(17,24,39,.12);
  font-size:13px;
  box-sizing:border-box;
  background:#fff;
}

.kv{
  display:grid;
  grid-template-columns: 120px 1fr;
  gap:6px 10px;
  font-size:12px;
  margin:8px 0 10px 0;
}
.kv div:nth-child(odd){ color:var(--muted); }
.kv div:nth-child(even){ color:#111827; font-weight:700; }

.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:900;
  border:1px solid rgba(17,24,39,.12);
  background:#fff;
  color:#111827;
}
.pill.green{ background:#e8f5e9; border-color:#c8e6c9; color:#1b5e20; }
.pill.red{ background:#ffebee; border-color:#ffcdd2; color:#b71c1c; }
.pill.gray{ background:#f3f4f6; border-color:#e5e7eb; color:#374151; }
.pill.orange{ background:#fff3e0; border-color:#ffe0b2; color:#e65100; }

.list{
  display:flex;
  flex-direction:column;
  gap:8px;
}

.item{
  border:1px solid rgba(17,24,39,.10);
  border-radius:10px;
  padding:10px 10px;
  background:#fff;
}
.item .row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:flex-start;
}
.item .name{
  font-weight:950;
  color:#111827;
  font-size:13px;
  line-height:1.2;
}
.item .meta{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
  line-height:1.25;
}
.item .actions{
  display:flex;
  gap:10px;
  align-items:center;
  white-space:nowrap;
}
.link{
  font-size:12px;
  color:var(--brand);
  font-weight:900;
  cursor:pointer;
  user-select:none;
}

/* MODAL */
.modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
  padding:16px;
}
.modal{
  width:min(760px, 100%);
  background:#fff;
  border-radius:14px;
  box-shadow:0 20px 60px rgba(0,0,0,.35);
  overflow:hidden;
  border:1px solid rgba(17,24,39,.12);
}
.modal-head{
  padding:14px 16px;
  border-bottom:1px solid rgba(17,24,39,.10);
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.modal-head .t{
  font-weight:950;
  color:#111827;
  font-size:14px;
}
.modal-body{
  padding:14px 16px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px 12px;
}
@media (max-width: 860px){
  .modal-body{ grid-template-columns: 1fr; }
}

.field label{
  display:block;
  font-size:12px;
  font-weight:900;
  color:#111827;
  margin-bottom:6px;
}
.field input, .field select{
  width:100%;
  padding:10px 10px;
  border-radius:10px;
  border:1px solid rgba(17,24,39,.12);
  font-size:13px;
  box-sizing:border-box;
  background:#fff;
}

.modal-foot{
  padding:12px 16px;
  border-top:1px solid rgba(17,24,39,.10);
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
}
.note{
  font-size:11px;
  color:var(--muted);
  line-height:1.35;
  max-width: 520px;
}

/* TOAST */
.toast{
  position:fixed;
  bottom:16px;
  left:16px;
  background:#111827;
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  font-size:12px;
  font-weight:800;
  opacity:0;
  transform: translateY(10px);
  transition: all .2s ease;
  z-index:3000;
  max-width: 720px;
}
.toast.show{
  opacity:1;
  transform: translateY(0);
}

/* Responsivo: empilha mapa + painel */
@media (max-width: 980px){
  body{ overflow:auto; }
  .app{
    position:relative;
    inset:auto;
    padding:12px;
    display:grid;
    grid-template-columns: 1fr;
    grid-template-rows: 56vh auto;
    gap:12px;
  }
  .map{ height:56vh; }
  #map{ height:56vh; }
}

</style>
</head>

<body>
<div class="app" id="app">
<div id="map" class="map"></div>

<div class="card panel" id="sidePanel">
  <div class="panel-head">
    <div>
      <div class="title">Alocação de Clientes</div>
      <div class="sub" id="selSub">Nenhum município selecionado</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn xs" id="btnZoomSP">Ver SP</button>
      <button class="btn primary" id="btnAdd" disabled>Adicionar cliente</button>
    </div>
  </div>

  <div class="panel-body">
    <div class="section">
      <div class="search">
        <input class="input" id="searchInput" placeholder="Buscar município..." />
        <button class="btn" id="btnClearSearch">Limpar</button>
      </div>

      <div id="searchResults" class="list"></div>

      <div style="height:10px"></div>

      <div class="kv">
        <div>Município</div><div id="selNome">-</div>
        <div>Código (IBGE)</div><div id="selCodigo">-</div>
        <div>Região (auto)</div><div id="selRegiao">-</div>
      </div>

      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill orange" id="pillSelected" style="display:none;">Selecionado</span>
        <span class="pill green" id="pillHasActive" style="display:none;">Tem ativo</span>
        <span class="pill red" id="pillOnlyInactive" style="display:none;">Só inativos</span>
        <span class="pill gray" id="pillNone" style="display:none;">Sem alocação</span>
      </div>

      <div style="height:10px"></div>

      <div class="note">
        Dados de clientes são salvos automaticamente neste dispositivo.
      </div>
    </div>

    <div class="divider"></div>

    <div class="section">
      <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:10px; margin-bottom:10px;">
        <div>
          <div class="title" style="font-size:13px;">Clientes por Localidade</div>
          <div class="sub" id="countSub">Carregando...</div>
        </div>
      </div>

      <div id="allocList" class="list"></div>
    </div>
  </div>
</div>

</div>

<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
<div class="modal">
<div class="modal-head">
<div class="t" id="modalTitle">Adicionar cliente</div>
<button class="btn" id="btnCloseModal">Fechar</button>
</div>

  <div class="modal-body">
    <div class="field">
      <label>Nome</label>
      <input id="fName" placeholder="Ex.: Nome do Cliente" />
    </div>
    <div class="field">
      <label>Segmento/Tipo</label>
      <input id="fRole" placeholder="Ex.: Varejo / Atacado" />
    </div>

    <div class="field">
      <label>Status</label>
      <select id="fStatus">
        <option value="ACTIVE">ATIVO</option>
        <option value="INACTIVE">INATIVO</option>
      </select>
    </div>

    <div class="field">
      <label>Tipo de alocação</label>
      <select id="fType">
        <option value="MUNICIPIO">Município selecionado</option>
        <option value="REGIAO">Região (campo do GeoJSON)</option>
      </select>
    </div>

    <div class="field" id="regionFieldWrap" style="display:none;">
      <label>Campo de região</label>
      <select id="fRegionField"></select>
    </div>

    <div class="field" id="regionValueWrap" style="display:none;">
      <label>Valor da região</label>
      <input id="fRegionValue" placeholder="Ex.: Registro / Campinas / ..." />
    </div>

    <div class="field">
      <label>Alocação selecionada</label>
      <input id="fTarget" disabled />
    </div>

    <div class="field">
      <label>ID (opcional)</label>
      <input id="fId" placeholder="Ex.: EMP012" />
    </div>
  </div>

  <div class="modal-foot">
    <div class="note" id="modalNote">
      O cadastro será salvo neste dispositivo.
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn danger" id="btnDelete" style="display:none;">Excluir</button>
      <button class="btn primary" id="btnSave">Salvar</button>
    </div>
  </div>
</div>

</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SP_URL = './sp.json';
const MUNICIPIOS_URL = './sp_municipios_2024.geojson';
const EMPREGADOS_URL = './employee_index.json';

const STORAGE_KEY = 'sp_allocations_v2'; // Nova versão para a nova estrutura

let FIELD_NOME = null;
let FIELD_CODIGO = null;

const REGION_FIELD_CANDIDATES = ['NM_MICRO','NM_IMEDIAT','NM_REGIAO','REGIAO','MICRO','IMEDIAT','NM_MESO','NM_RGI','NM_RGI_IM'];

let municipiosGeo = null;
let spOutlineLayer = null;
let municipiosLayer = null;

let selectedCode = null;
let selectedFeature = null;

// Nova estrutura de DB baseada em mapa (objeto)
let db = { updatedAt: null, clients: {} };

let codeToFeature = new Map();
let nameIndex = [];
let regionIndex = new Map();
let muniStats = new Map();

const $ = (id) => document.getElementById(id);

const btnAdd = $('btnAdd');
const searchInput = $('searchInput');
const searchResults = $('searchResults');
const btnClearSearch = $('btnClearSearch');

const selSub = $('selSub');
const selNome = $('selNome');
const selCodigo = $('selCodigo');
const selRegiao = $('selRegiao');

const pillSelected = $('pillSelected');
const pillHasActive = $('pillHasActive');
const pillOnlyInactive = $('pillOnlyInactive');
const pillNone = $('pillNone');

const allocList = $('allocList');
const countSub = $('countSub');

const btnZoomSP = $('btnZoomSP');

const modalBackdrop = $('modalBackdrop');
const btnCloseModal = $('btnCloseModal');
const btnSave = $('btnSave');
const btnDelete = $('btnDelete');
const modalTitle = $('modalTitle');

const fName = $('fName');
const fRole = $('fRole');
const fStatus = $('fStatus');
const fType = $('fType');
const fRegionField = $('fRegionField');
const fRegionValue = $('fRegionValue');
const fTarget = $('fTarget');
const fId = $('fId');

const regionFieldWrap = $('regionFieldWrap');
const regionValueWrap = $('regionValueWrap');

const toast = $('toast');

let editingClientId = null;

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(showToast._t);
  toast._t = setTimeout(() => toast.classList.remove('show'), 2200);
}

function normalize(str){
  return String(str || '')
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .toUpperCase().trim();
}

function nowIso(){
  return new Date().toISOString();
}

function safeStr(v){
  if (v === null || v === undefined) return '';
  return String(v);
}

function detectFields(geo){
  const f = geo.features?.[0];
  const props = f?.properties || {};
  const keys = Object.keys(props);

  FIELD_NOME =
    keys.find(k => /NM.*MUN/i.test(k)) ||
    keys.find(k => /NOME/i.test(k)) ||
    'NM_MUN';

  FIELD_CODIGO =
    keys.find(k => /(CD|COD).*MUN/i.test(k)) ||
    keys.find(k => /IBGE/i.test(k)) ||
    'CD_MUN';

  return { keys };
}

function getNome(props){
  return safeStr(props?.[FIELD_NOME]) || 'Município';
}

function getCodigo(props){
  return safeStr(props?.[FIELD_CODIGO]).trim();
}

function buildIndexes(){
  codeToFeature = new Map();
  nameIndex = [];
  regionIndex = new Map();

  const { keys } = detectFields(municipiosGeo);

  const availableRegionFields = REGION_FIELD_CANDIDATES.filter(c => keys.includes(c));
  for (const rf of availableRegionFields){
    regionIndex.set(rf, new Map());
  }

  for (const ft of municipiosGeo.features || []){
    const code = getCodigo(ft.properties);
    const name = getNome(ft.properties);
    if (!code) continue;

    codeToFeature.set(code, ft);
    nameIndex.push({ nameKey: normalize(name), name, code });

    for (const rf of availableRegionFields){
      const val = safeStr(ft.properties?.[rf]).trim();
      if (!val) continue;
      const byValue = regionIndex.get(rf);
      if (!byValue.has(val)) byValue.set(val, new Set());
      byValue.get(val).add(code);
    }
  }

  fRegionField.innerHTML = '';
  if (availableRegionFields.length){
    for (const rf of availableRegionFields){
      const opt = document.createElement('option');
      opt.value = rf;
      opt.textContent = rf;
      fRegionField.appendChild(opt);
    }
  } else {
    const opt = document.createElement('option');
    opt.value = '';
    opt.textContent = 'Nenhum campo de região encontrado';
    fRegionField.appendChild(opt);
  }
}

function loadDbFromLocalStorage(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed.clients !== 'object') return false;
    db = parsed;
    return true;
  }catch(e){
    return false;
  }
}

function saveDbToLocalStorage(){
  db.updatedAt = nowIso();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
}

async function tryLoadInitialEmployeeIndex(){
  try{
    const r = await fetch(EMPREGADOS_URL, { cache:'no-store' });
    if (!r.ok) return false;
    const j = await r.json();
    
    // Se o DB local estiver vazio ou for a versão antiga, carregar do JSON
    if (!db.clients || Object.keys(db.clients).length === 0){
      db = {
        updatedAt: j.updatedAt || nowIso(),
        clients: j.clients || {}
      };
      saveDbToLocalStorage();
      showToast('Dados dos clientes carregados com sucesso');
    }
    return true;
  }catch(e){
    return false;
  }
}

function expandAssignmentToCodes(assignment){
  if (!assignment) return [];
  if (assignment.type === 'MUNICIPIO'){
    const code = String(assignment.code || '').trim();
    return code ? [code] : [];
  }
  if (assignment.type === 'REGIAO'){
    const field = assignment.field;
    const value = assignment.value;
    const byField = regionIndex.get(field);
    if (!byField) return [];
    const set = byField.get(value);
    return set ? Array.from(set) : [];
  }
  return [];
}

function rebuildStats(){
  muniStats = new Map();

  function ensure(code){
    if (!muniStats.has(code)){
      muniStats.set(code, { activeCount:0, totalCount:0, clients:[] });
    }
    return muniStats.get(code);
  }

  for (const id in db.clients){
    const client = db.clients[id];
    const st = (client.status || 'ACTIVE').toUpperCase();
    
    // Suportar tanto a estrutura antiga (assignment único) quanto a nova (assignments array)
    const assignments = client.assignments || (client.assignment ? [client.assignment] : []);
    
    for (const assignment of assignments){
      const codes = expandAssignmentToCodes(assignment);
      for (const code of codes){
        const entry = ensure(code);
        entry.totalCount += 1;
        if (st === 'ACTIVE') entry.activeCount += 1;
        entry.clients.push({ ...client, id });
      }
    }
  }
}

function getMunicipioRegionSummary(props){
  for (const rf of REGION_FIELD_CANDIDATES){
    const v = props?.[rf];
    if (v) return `${rf}: ${v}`;
  }
  return '-';
}

function fillColorForCode(code){
  const entry = muniStats.get(code);
  if (!entry) return getComputedStyle(document.documentElement).getPropertyValue('--c-none').trim();
  if (entry.activeCount > 0) return getComputedStyle(document.documentElement).getPropertyValue('--c-active').trim();
  return getComputedStyle(document.documentElement).getPropertyValue('--c-inactive').trim();
}

function styleMunicipio(feature){
  const code = getCodigo(feature.properties);
  const baseFill = fillColorForCode(code);
  const isSelected = selectedCode && code === selectedCode;

  return {
    color: isSelected ? getComputedStyle(document.documentElement).getPropertyValue('--c-selected').trim() : '#ffffff',
    weight: isSelected ? 3 : 0.8,
    opacity: 1,
    fillColor: baseFill,
    fillOpacity: isSelected ? 0.28 : 0.72
  };
}

function highlightFeature(e){
  const layer = e.target;
  layer.setStyle({ weight: 2.2, color:'#111827', fillOpacity: 0.82 });
  layer.bringToFront();
}

function resetHighlight(e){
  if (municipiosLayer) municipiosLayer.resetStyle(e.target);
}

function selectMunicipioByFeature(feature, layer){
  selectedFeature = feature;
  selectedCode = getCodigo(feature.properties);

  btnAdd.disabled = !selectedCode;

  const name = getNome(feature.properties);
  selSub.textContent = `Selecionado: ${name}`;
  selNome.textContent = name;
  selCodigo.textContent = selectedCode || '-';
  selRegiao.textContent = getMunicipioRegionSummary(feature.properties);

  pillSelected.style.display = selectedCode ? 'inline-flex' : 'none';

  const entry = muniStats.get(selectedCode);
  pillHasActive.style.display = (entry && entry.activeCount > 0) ? 'inline-flex' : 'none';
  pillOnlyInactive.style.display = (entry && entry.totalCount > 0 && entry.activeCount === 0) ? 'inline-flex' : 'none';
  pillNone.style.display = (!entry) ? 'inline-flex' : 'none';

  if (municipiosLayer) municipiosLayer.setStyle(styleMunicipio);

  if (layer){
    const bounds = layer.getBounds();
    map.fitBounds(bounds, { padding:[40,40], maxZoom: 11, animate:true, duration:0.6 });
  }

  renderAllocationsPanel();
}

function onMunicipioClick(e){
  const layer = e.target;
  const feature = layer.feature;
  selectMunicipioByFeature(feature, layer);
}

function renderSearchResults(items){
  searchResults.innerHTML = '';

  if (!items.length){
    const div = document.createElement('div');
    div.className = 'muted';
    div.style.padding = '8px';
    div.textContent = 'Nenhum município encontrado.';
    searchResults.appendChild(div);
    return;
  }

  for (const item of items.slice(0, 8)){
    const div = document.createElement('div');
    div.className = 'item link';
    div.style.padding = '8px 10px';
    div.textContent = item.name;
    div.onclick = () => {
      const ft = codeToFeature.get(item.code);
      if (ft){
        const layer = municipiosLayer.getLayers().find(l => getCodigo(l.feature.properties) === item.code);
        selectMunicipioByFeature(ft, layer);
        searchInput.value = '';
        searchResults.innerHTML = '';
      }
    };
    searchResults.appendChild(div);
  }
}

function renderAllocationsPanel(){
  allocList.innerHTML = '';
  const entry = muniStats.get(selectedCode);

  if (!entry || !entry.clients.length){
    countSub.textContent = 'Nenhum cliente alocado.';
    return;
  }

  countSub.textContent = `${entry.clients.length} cliente(s) nesta localidade.`;

  for (const client of entry.clients){
    const div = document.createElement('div');
    div.className = 'item';
    const isActive = client.status === 'ACTIVE';
    
    div.innerHTML = `
      <div class="row">
        <div>
          <div class="name">${client.name}</div>
          <div class="meta">${client.role}</div>
          <div class="pill ${isActive ? 'green' : 'red'}" style="margin-top:6px; font-size:10px;">
            ${isActive ? 'ATIVO' : 'INATIVO'}
          </div>
        </div>
        <div class="actions">
          <span class="link" onclick="openEditModal('${client.id}')">Editar</span>
        </div>
      </div>
    `;
    allocList.appendChild(div);
  }
}

function openAddModal(){
  if (!selectedCode) return;
  editingClientId = null;
  modalTitle.textContent = 'Adicionar cliente';
  btnDelete.style.display = 'none';
  
  fName.value = '';
  fRole.value = '';
  fStatus.value = 'ACTIVE';
  fType.value = 'MUNICIPIO';
  fId.value = '';
  
  updateModalFields();
  modalBackdrop.style.display = 'flex';
}

function openEditModal(id){
  const client = db.clients[id];
  if (!client) return;
  
  editingClientId = id;
  modalTitle.textContent = 'Editar cliente';
  btnDelete.style.display = 'block';
  
  fName.value = client.name;
  fRole.value = client.role;
  fStatus.value = client.status;
  fId.value = id;
  
  // Para edição, pegamos o primeiro assignment para o formulário simples
  const assignment = client.assignments?.[0] || client.assignment || { type:'MUNICIPIO', code: selectedCode };
  fType.value = assignment.type;
  if (assignment.type === 'REGIAO'){
    fRegionField.value = assignment.field;
    fRegionValue.value = assignment.value;
  }
  
  updateModalFields();
  modalBackdrop.style.display = 'flex';
}

function updateModalFields(){
  const type = fType.value;
  regionFieldWrap.style.display = type === 'REGIAO' ? 'block' : 'none';
  regionValueWrap.style.display = type === 'REGIAO' ? 'block' : 'none';
  
  if (type === 'MUNICIPIO'){
    fTarget.value = selNome.textContent;
  } else {
    fTarget.value = 'Baseado em campo regional';
  }
}

function saveClient(){
  const name = fName.value.trim();
  if (!name){
    showToast('O nome é obrigatório.');
    return;
  }

  const id = fId.value.trim() || 'CLI_' + Math.random().toString(36).substr(2, 9).toUpperCase();
  
  const assignment = fType.value === 'MUNICIPIO' 
    ? { type: 'MUNICIPIO', code: selectedCode }
    : { type: 'REGIAO', field: fRegionField.value, value: fRegionValue.value.trim() };

  const clientData = {
    name: name,
    role: fRole.value.trim(),
    status: fStatus.value,
    assignments: [assignment] // Nova estrutura sempre usa array
  };

  // Se estiver editando e o ID mudou, remover o antigo
  if (editingClientId && editingClientId !== id){
    delete db.clients[editingClientId];
  }

  db.clients[id] = clientData;
  
  saveDbToLocalStorage();
  rebuildStats();
  municipiosLayer.setStyle(styleMunicipio);
  renderAllocationsPanel();
  
  modalBackdrop.style.display = 'none';
  showToast('Cliente salvo com sucesso!');
}

function deleteClient(){
  if (!editingClientId) return;
  if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
  
  delete db.clients[editingClientId];
  saveDbToLocalStorage();
  rebuildStats();
  municipiosLayer.setStyle(styleMunicipio);
  renderAllocationsPanel();
  
  modalBackdrop.style.display = 'none';
  showToast('Cliente excluído.');
}

// Inicialização do Mapa
const map = L.map('map', {
  center: [-23.55, -46.63],
  zoom: 7,
  zoomControl: false
});

L.control.zoom({ position: 'bottomright' }).addTo(map);

async function init(){
  try{
    const [spRes, muniRes] = await Promise.all([
      fetch(SP_URL).then(r => r.json()),
      fetch(MUNICIPIOS_URL).then(r => r.json())
    ]);

    municipiosGeo = muniRes;
    buildIndexes();
    
    loadDbFromLocalStorage();
    await tryLoadInitialEmployeeIndex();
    rebuildStats();

    spOutlineLayer = L.geoJSON(spRes, {
      style: { color: '#1e3a8a', weight: 2, fill: false, opacity: 0.4 },
      interactive: false
    }).addTo(map);

    municipiosLayer = L.geoJSON(muniRes, {
      style: styleMunicipio,
      onEachFeature: (feature, layer) => {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: onMunicipioClick
        });
      }
    }).addTo(map);

    map.fitBounds(spOutlineLayer.getBounds());
    countSub.textContent = 'Selecione um município no mapa.';

  }catch(e){
    console.error(e);
    showToast('Erro ao carregar dados geográficos.');
  }
}

// Eventos
btnAdd.onclick = openAddModal;
btnCloseModal.onclick = () => modalBackdrop.style.display = 'none';
btnSave.onclick = saveClient;
btnDelete.onclick = deleteClient;
fType.onchange = updateModalFields;

btnZoomSP.onclick = () => {
  if (spOutlineLayer) map.fitBounds(spOutlineLayer.getBounds(), { animate:true });
};

searchInput.oninput = (e) => {
  const val = normalize(e.target.value);
  if (val.length < 2){
    searchResults.innerHTML = '';
    return;
  }
  const matches = nameIndex.filter(x => x.nameKey.includes(val));
  renderSearchResults(matches);
};

btnClearSearch.onclick = () => {
  searchInput.value = '';
  searchResults.innerHTML = '';
};

init();

</script>
</body>
</html>
