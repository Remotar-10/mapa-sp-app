<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>São Paulo | Clientes por Município</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
:root{
--panel:#ffffff; --muted:#6b7280; --text:#111827; --brand:#1e3a8a;
--c-none:#bdbdbd; --c-inactive:#c62828; --c-active:#2e7d32; --c-selected:#ff6f00;
}
html, body { height:100%; margin:0; font-family: system-ui, -apple-system, sans-serif; }
body{ overflow:hidden; background:#f3f4f6; }
.app{ position:fixed; inset:16px; display:grid; grid-template-columns: 1fr 460px; gap:12px; }
#map, .map { height:100%; width:100%; border-radius:10px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,.1); background:#fff; }
.card{ background:var(--panel); border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,.1); border:1px solid rgba(0,0,0,.05); }
.panel{ display:flex; flex-direction:column; overflow:hidden; }
.panel-head{ padding:14px; border-bottom:1px solid rgba(0,0,0,.08); display:flex; justify-content:space-between; align-items:center; }
.title{ font-weight:900; font-size:14px; color:var(--text); }
.sub{ color:var(--muted); font-size:12px; }
.panel-body{ padding:14px; overflow-y:auto; flex:1; }
.search{ display:flex; gap:8px; margin-bottom:12px; }
input, select{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,.1); font-size:13px; }
.list{ display:flex; flex-direction:column; gap:10px; }
.item{ border:1px solid #e5e7eb; border-radius:10px; padding:12px; background:#fff; border-left-width:6px; }
.item .name{ font-weight:800; font-size:14px; display:flex; align-items:center; gap:8px; }
.color-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
.btn{ padding:10px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:700; font-size:12px; }
.btn.primary{ background:var(--brand); color:#fff; border:none; }
.btn.xs{ padding:5px 10px; font-size:11px; }
.kv{ display:grid; grid-template-columns: 100px 1fr; gap:5px; font-size:12px; margin:10px 0; }
.pill{ padding:4px 10px; border-radius:20px; font-size:11px; font-weight:800; display:inline-block; }
.pill.green{ background:#e8f5e9; color:#2e7d32; }
.pill.red{ background:#ffebee; color:#c62828; }
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ background:#fff; padding:20px; border-radius:12px; width:400px; max-width:90%; }
.toast{ position:fixed; bottom:20px; left:20px; background:#333; color:#fff; padding:12px 20px; border-radius:8px; display:none; z-index:10000; }
@media (max-width: 980px){ .app{ grid-template-columns: 1fr; position:static; height:auto; padding:10px; } .map, #map{ height:400px; } }
</style>
</head>
<body>
<div class="app">
  <div id="map"></div>
  <div class="card panel">
    <div class="panel-head">
      <div><div class="title">Gestão de Clientes</div><div class="sub" id="selSub">Selecione no mapa</div></div>
      <button class="btn primary" id="btnAdd" disabled>+ Adicionar</button>
    </div>
    <div class="panel-body">
      <div class="search">
        <input id="searchInput" placeholder="Buscar cidade...">
      </div>
      <div id="searchResults" class="list"></div>
      <div class="kv">
        <div>Cidade:</div><strong id="selNome">-</strong>
        <div>Código:</div><span id="selCodigo">-</span>
      </div>
      <hr style="opacity:0.1">
      <div id="allocList" class="list"></div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <h3 id="modalTitle">Adicionar Cliente</h3>
    <div style="display:flex; flex-direction:column; gap:10px;">
      <input id="fName" placeholder="Nome do Cliente (ex: MONTEBELLO)">
      <input id="fRole" placeholder="Segmento">
      <select id="fStatus"><option value="ACTIVE">ATIVO</option><option value="INACTIVE">INATIVO</option></select>
      <button class="btn primary" id="btnSave">Salvar Cliente</button>
      <button class="btn" onclick="document.getElementById('modalBackdrop').style.display='none'">Cancelar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const MUNICIPIOS_URL = './sp_municipios_2024.geojson';
const STORAGE_KEY = 'sp_map_data_v3';

let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { clients: {} };
let municipiosGeo, selectedCode, map, municipiosLayer;

function generateColor() {
  return `hsl(${Math.floor(Math.random() * 360)}, 70%, 50%)`;
}

function showToast(m){ 
  const t = document.getElementById('toast'); 
  t.textContent = m; t.style.display='block'; 
  setTimeout(()=>t.style.display='none', 2000); 
}

function save(){ 
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); 
  rebuildStats();
  if(municipiosLayer) municipiosLayer.setStyle(styleFeature);
}

function rebuildStats(){
  window.muniStats = new Map();
  Object.keys(db.clients).forEach(id => {
    const c = db.clients[id];
    c.codes.forEach(code => {
      if(!muniStats.has(code)) muniStats.set(code, []);
      muniStats.get(code).push(c);
    });
  });
}

function styleFeature(f){
  const code = f.properties.CD_MUN || f.properties.cod_municipio || f.properties.codigo_ibge;
  const stats = muniStats.get(String(code));
  let color = '#bdbdbd';
  if(stats && stats.length > 0){
    color = stats.some(c => c.status === 'ACTIVE') ? '#2e7d32' : '#c62828';
  }
  return { fillColor: color, fillOpacity: 0.7, color: '#fff', weight: 1 };
}

async function init(){
  map = L.map('map').setView([-23.55, -46.63], 7);
  rebuildStats();
  try {
    const r = await fetch(MUNICIPIOS_URL);
    municipiosGeo = await r.json();
    municipiosLayer = L.geoJSON(municipiosGeo, {
      style: styleFeature,
      onEachFeature: (f, l) => {
        l.on('click', () => {
          selectedCode = String(f.properties.CD_MUN || f.properties.cod_municipio || f.properties.codigo_ibge);
          document.getElementById('selNome').textContent = f.properties.NM_MUN || f.properties.nome;
          document.getElementById('selCodigo').textContent = selectedCode;
          document.getElementById('btnAdd').disabled = false;
          renderList();
        });
      }
    }).addTo(map);
    map.fitBounds(municipiosLayer.getBounds());
  } catch(e) { showToast("Erro ao carregar mapa."); }
}

function renderList(){
  const list = document.getElementById('allocList');
  list.innerHTML = '';
  const clients = muniStats.get(selectedCode) || [];
  clients.forEach(c => {
    const item = document.createElement('div');
    item.className = 'item';
    item.style.borderLeftColor = c.color;
    item.innerHTML = `
      <div class="name"><span class="color-dot" style="background:${c.color}"></span> ${c.name}</div>
      <div class="sub">${c.role}</div>
      <div class="pill ${c.status==='ACTIVE'?'green':'red'}">${c.status}</div>
    `;
    list.appendChild(item);
  });
}

document.getElementById('btnAdd').onclick = () => document.getElementById('modalBackdrop').style.display='flex';

document.getElementById('btnSave').onclick = () => {
  const name = document.getElementById('fName').value.trim();
  const role = document.getElementById('fRole').value.trim();
  const status = document.getElementById('fStatus').value;
  if(!name) return showToast("Digite o nome");

  const id = name.toUpperCase().replace(/\s+/g, '_');
  if(!db.clients[id]){
    db.clients[id] = { name, role, status, color: generateColor(), codes: [selectedCode] };
  } else {
    if(!db.clients[id].codes.includes(selectedCode)) db.clients[id].codes.push(selectedCode);
  }
  
  save();
  renderList();
  document.getElementById('modalBackdrop').style.display='none';
  showToast("Salvo!");
};

init();
</script>
</body>
</html>