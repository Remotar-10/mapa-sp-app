<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S√£o Paulo - Funcion√°rios por Munic√≠pio</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }
    #map { height: 100%; width: 100%; }

    /* Header */
    .header {
      position: absolute;
      top: 15px;
      left: 15px;
      background: white;
      padding: 14px 18px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 320px;
    }
    .header h1 {
      margin: 0 0 4px 0;
      font-size: 18px;
      color: #1e3a8a;
      font-weight: 600;
    }
    .header p {
      margin: 0;
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }

    /* Legenda */
    .legenda {
      position: absolute;
      top: 15px;
      right: 15px;
      background: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1000;
      font-size: 12px;
      max-width: 280px;
    }
    .legenda h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #111827;
      font-weight: 600;
    }
    .legenda-item {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .legenda-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: 8px;
      flex-shrink: 0;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* Info Box (painel de detalhes do munic√≠pio) */
    .info-box {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: white;
      padding: 14px 18px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 340px;
      font-size: 13px;
    }
    .info-box h2 {
      margin: 0 0 6px 0;
      font-size: 16px;
      color: #111827;
      font-weight: 600;
    }
    .info-box p {
      margin: 4px 0;
      line-height: 1.5;
    }
    .info-box .small {
      font-size: 11px;
      color: #6b7280;
    }
    .info-box .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 4px;
    }
    .status-occupied { background: #FFE0B2; color: #E65100; }
    .status-next { background: #FFF9C4; color: #F57F17; }
    .status-active { background: #C8E6C9; color: #1B5E20; }
    .status-inactive { background: #FFCDD2; color: #B71C1C; }
    .status-none { background: #E0E0E0; color: #424242; }

    /* Search Box */
    .search-box {
      position: absolute;
      bottom: 15px;
      right: 15px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1000;
      font-size: 12px;
      width: 240px;
    }
    .search-box input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      box-sizing: border-box;
    }
    .search-box input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    .search-results {
      margin-top: 8px;
      max-height: 180px;
      overflow-y: auto;
    }
    .search-results div {
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .search-results div:hover {
      background: #f3f4f6;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="header">
    <h1>S√£o Paulo - Funcion√°rios por Munic√≠pio</h1>
    <p>Cada munic√≠pio √© colorido conforme a atividade dos funcion√°rios.</p>
  </div>

  <div class="legenda">
    <h3>Legenda</h3>
    <div class="legenda-item">
      <span class="legenda-color" style="background:#FF6F00;"></span>
      <span>Pelo menos 1 funcion√°rio ATIVO</span>
    </div>
    <div class="legenda-item">
      <span class="legenda-color" style="background:#1976D2;"></span>
      <span>Funcion√°rios somente ATIVOS (nenhum ativo)</span>
    </div>
    <div class="legenda-item">
      <span class="legenda-color" style="background:#BDBDBD;"></span>
      <span>Nenhum funcion√°rio no √≠ndice</span>
    </div>
  </div>

  <div class="info-box" id="infoBox">
    <h2 id="infoNome">Selecione um munic√≠pio</h2>
    <p id="infoCodigo" class="small">C√≥digo IBGE: -</p>
    <div id="infoStatus"></div>
    <p id="infoResumo"></p>
    <p id="infoLista" class="small"></p>
    <p id="infoAtualizado" class="small"></p>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Buscar munic√≠pio..." />
    <div class="search-results" id="searchResults"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ============================================================
    // CONFIGURA√á√ÉO: Caminhos dos arquivos (mesma pasta do index.html)
    // ============================================================
    const SP_URL          = './sp.json';
    const MUNICIPIOS_URL  = './sp_municipios_2024.geojson';
    const EMPREGADOS_URL  = './employee_index.json';

    // ============================================================
    // VARI√ÅVEIS GLOBAIS
    // ============================================================
    let FIELD_NOME   = null;  // detectado automaticamente
    let FIELD_CODIGO = null;  // detectado automaticamente

    const map = L.map('map').setView([-22.5, -48.5], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let spOutlineLayer = null;
    let municipiosLayer = null;

    // c√≥digo munic√≠pio -> { activeCount, totalCount, employees, occupiedBy, nextBy }
    let activityByMunicipalityCode = new Map();
    let employeeIndexRaw = null;

    // √≠ndice para busca: nome normalizado -> [{ nome, layer, bounds }]
    const municipiosPorNome = new Map();

    // ============================================================
    // UTILIT√ÅRIOS
    // ============================================================
    async function loadJSON(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('Erro ao carregar ' + url + ': ' + res.status);
      return await res.json();
    }

    function normalizeName(str) {
      return String(str)
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .toUpperCase()
        .trim();
    }

    // ============================================================
    // DETEC√á√ÉO AUTOM√ÅTICA DE CAMPOS DO GEOJSON
    // ============================================================
    function detectFieldNames(municipiosGeoJSON) {
      const f = municipiosGeoJSON.features?.[0];
      const props = f?.properties || {};
      const keys = Object.keys(props);

      if (!keys.length) {
        console.warn('‚ö†Ô∏è Nenhuma propriedade encontrada nas features do GeoJSON.');
        return;
      }

      // Nome do munic√≠pio
      FIELD_NOME =
        keys.find(k => /NM.*MUN/i.test(k)) ||
        keys.find(k => /NM.*MUNIC/i.test(k)) ||
        keys.find(k => /NOME/i.test(k)) ||
        keys[0];

      // C√≥digo do munic√≠pio
      FIELD_CODIGO =
        keys.find(k => /(CD|COD).*MUN/i.test(k)) ||
        keys.find(k => /(CD|COD).*(IBGE|GEO)/i.test(k)) ||
        keys.find(k => /IBGE/i.test(k)) ||
        null;

      console.log('‚úÖ Campos detectados no GeoJSON:');
      console.log('   FIELD_NOME  =', FIELD_NOME);
      console.log('   FIELD_CODIGO=', FIELD_CODIGO);
    }

    // ============================================================
    // CONSTRU√á√ÉO DO √çNDICE DE ATIVIDADE (com rotas e ocupa√ß√£o)
    // ============================================================
    function buildMunicipalityActivityIndex(employeeIndex) {
      const map = new Map();
      if (!employeeIndex || !Array.isArray(employeeIndex.employees)) return map;

      function ensure(code) {
        if (!map.has(code)) {
          map.set(code, {
            activeCount: 0,
            totalCount: 0,
            employees: [],
            occupiedBy: null,  // employeeId do funcion√°rio atual neste munic√≠pio
            nextBy: null       // employeeId do pr√≥ximo funcion√°rio
          });
        }
        return map.get(code);
      }

      for (const emp of employeeIndex.employees) {
        const status = String(emp.status || '').toUpperCase();

        // 1) Munic√≠pios atendidos (compat√≠vel com vers√£o anterior)
        const servedCodes = [];

        if (emp.municipalityCode) {
          servedCodes.push(String(emp.municipalityCode).trim());
        }

        if (Array.isArray(emp.municipalitiesServed)) {
          for (const c of emp.municipalitiesServed) {
            const v = String(c || '').trim();
            if (v) servedCodes.push(v);
          }
        }

        // 2) Rota (novo: array de c√≥digos de munic√≠pios)
        const route = Array.isArray(emp.route) 
          ? emp.route.map(x => String(x).trim()).filter(Boolean) 
          : [];
        
        const current = String(emp.currentMunicipalityCode || '').trim();

        // Unifica tudo como "atendido"
        const allServed = Array.from(new Set([...servedCodes, ...route])).filter(Boolean);

        // Registra todos os munic√≠pios atendidos
        for (const code of allServed) {
          const entry = ensure(code);
          entry.totalCount += 1;
          if (status === 'ACTIVE') entry.activeCount += 1;
          entry.employees.push(emp);
        }

        // 3) Marca munic√≠pio atual (ocupado)
        if (current) {
          const eCur = ensure(current);
          eCur.occupiedBy = emp.employeeId || emp.employeeName || 'Funcion√°rio';
        }

        // 4) Marca pr√≥ximo munic√≠pio
        if (route.length && current) {
          const idx = route.indexOf(current);
          const next = (idx >= 0 && idx + 1 < route.length) ? route[idx + 1] : null;
          if (next) {
            const eNext = ensure(next);
            eNext.nextBy = emp.employeeId || emp.employeeName || 'Funcion√°rio';
          }
        }
      }

      return map;
    }

    // ============================================================
    // COR DO MUNIC√çPIO (prioridade: ocupado > ativo > cinza)
    // ============================================================
    function getFillColorByActivity(entry) {
      if (!entry) return '#BDBDBD';           // cinza: nenhum funcion√°rio
      if (entry.occupiedBy) return '#FF6F00'; // laranja: ocupado (funcion√°rio atual)
      if (entry.activeCount > 0) return '#1976D2'; // azul: pelo menos 1 ativo
      return '#BDBDBD';                       // cinza: sem ativos
    }

    // ============================================================
    // LEITURA DE PROPRIEDADES DO GEOJSON
    // ============================================================
    function getCodigoFromProps(props) {
      if (!props || !FIELD_CODIGO) return '';
      return String(props[FIELD_CODIGO] ?? '').trim();
    }

    function getNomeFromProps(props) {
      if (!props || !FIELD_NOME) return 'Munic√≠pio desconhecido';
      return String(props[FIELD_NOME] ?? 'Munic√≠pio desconhecido');
    }

    // ============================================================
    // ESTILO E INTERA√á√ÉO DO MAPA
    // ============================================================
    function styleMunicipio(feature) {
      const props = feature.properties || {};
      const code  = getCodigoFromProps(props);
      const entry = activityByMunicipalityCode.get(code);

      return {
        color: '#ffffff',
        weight: 0.8,
        fillOpacity: 0.7,
        fillColor: getFillColorByActivity(entry)
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({
        weight: 2.5,
        color: '#111827',
        fillOpacity: 0.9
      });
      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
        layer.bringToFront();
      }
    }

    function resetHighlight(e) {
      if (municipiosLayer) municipiosLayer.resetStyle(e.target);
    }

    // ============================================================
    // CLIQUE NO MUNIC√çPIO: atualiza painel de informa√ß√µes
    // ============================================================
    function onMunicipioClick(e) {
      const layer = e.target;
      const feature = layer.feature;
      const props = feature.properties || {};

      const nome = getNomeFromProps(props);
      const code = getCodigoFromProps(props) || '-';

      const entry = activityByMunicipalityCode.get(code);

      const infoNome       = document.getElementById('infoNome');
      const infoCodigo     = document.getElementById('infoCodigo');
      const infoStatus     = document.getElementById('infoStatus');
      const infoResumo     = document.getElementById('infoResumo');
      const infoLista      = document.getElementById('infoLista');
      const infoAtualizado = document.getElementById('infoAtualizado');

      infoNome.textContent   = nome;
      infoCodigo.textContent = 'C√≥digo IBGE: ' + code;

      // Limpa status anterior
      infoStatus.innerHTML = '';

      if (!entry) {
        infoStatus.innerHTML = '<span class="status-badge status-none">Sem funcion√°rios</span>';
        infoResumo.textContent = 'Nenhum funcion√°rio cadastrado neste munic√≠pio.';
        infoLista.textContent  = '';
      } else {
        // Badges de status
        let badges = '';
        if (entry.occupiedBy) {
          badges += `<span class="status-badge status-occupied">üî¥ Ocupado: ${entry.occupiedBy}</span> `;
        }
        if (entry.nextBy) {
          badges += `<span class="status-badge status-next">‚ö†Ô∏è Pr√≥ximo: ${entry.nextBy}</span> `;
        }
        if (entry.activeCount > 0) {
          badges += `<span class="status-badge status-active">‚úÖ ${entry.activeCount} ativo(s)</span> `;
        }
        if (entry.totalCount > entry.activeCount) {
          const inativos = entry.totalCount - entry.activeCount;
          badges += `<span class="status-badge status-inactive">‚ùå ${inativos} inativo(s)</span>`;
        }
        infoStatus.innerHTML = badges;

        // Resumo
        infoResumo.textContent = 
          `Total de funcion√°rios: ${entry.totalCount} (${entry.activeCount} ativos)`;

        // Lista de funcion√°rios
        const nomes = entry.employees
          .map(emp => {
            const st = (emp.status || '').toUpperCase() === 'ACTIVE' ? '‚úÖ' : '‚ùå';
            return `${st} ${emp.employeeName || emp.employeeId}`;
          })
          .join(', ');
        infoLista.textContent = nomes ? 'Funcion√°rios: ' + nomes : '';
      }

      // Data de atualiza√ß√£o
      if (employeeIndexRaw && employeeIndexRaw.updatedAt) {
        infoAtualizado.textContent = 'üìÖ Atualizado em: ' + employeeIndexRaw.updatedAt;
      } else {
        infoAtualizado.textContent = '';
      }

      // Zoom no munic√≠pio
      const bounds = layer.getBounds();
      map.fitBounds(bounds, { maxZoom: 11, padding: [30, 30] });
    }

    // ============================================================
    // onEachFeature: eventos + √≠ndice de busca
    // ============================================================
    function onEachMunicipio(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: onMunicipioClick
      });

      const props = feature.properties || {};
      const nome  = getNomeFromProps(props);

      if (nome) {
        const key = normalizeName(nome);
        if (!municipiosPorNome.has(key)) {
          municipiosPorNome.set(key, []);
        }
        municipiosPorNome.get(key).push({
          nome,
          layer,
          bounds: layer.getBounds()
        });
      }
    }

    // ============================================================
    // INICIALIZA√á√ÉO
    // ============================================================
    async function init() {
      try {
        console.log('üîÑ Carregando dados...');

        // 1) Contorno do estado
        const sp = await loadJSON(SP_URL);
        const spFeature = (sp.type === 'FeatureCollection') ? sp.features[0] : sp;

        spOutlineLayer = L.geoJSON(spFeature, {
          style: { color: '#000', weight: 2.5, fill: false }
        }).addTo(map);

        // 2) Municipios (carrega primeiro para detectar campos)
        const municipios = await loadJSON(MUNICIPIOS_URL);
        if (municipios.type !== 'FeatureCollection') {
          console.error('‚ùå O GeoJSON de munic√≠pios n√£o √© FeatureCollection. type=', municipios.type);
        }

        detectFieldNames(municipios);

        // 3) √çndice de funcion√°rios
        employeeIndexRaw = await loadJSON(EMPREGADOS_URL);
        activityByMunicipalityCode = buildMunicipalityActivityIndex(employeeIndexRaw);

        console.log('üìä √çndice de atividade constru√≠do:', activityByMunicipalityCode.size, 'munic√≠pios');

        // 4) Camada de munic√≠pios
        municipiosLayer = L.geoJSON(municipios, {
          style: styleMunicipio,
          onEachFeature: onEachMunicipio
        }).addTo(map);

        map.fitBounds(municipiosLayer.getBounds(), { padding: [30, 30] });

        console.log('‚úÖ Mapa carregado com sucesso!');
      } catch (err) {
        console.error('‚ùå Erro ao carregar dados:', err);
        alert('Erro ao carregar dados: ' + err.message);
      }
    }

    // ============================================================
    // BUSCA DE MUNIC√çPIOS
    // ============================================================
    const searchInput   = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    searchInput.addEventListener('input', () => {
      const termRaw = searchInput.value;
      const term = normalizeName(termRaw);
      searchResults.innerHTML = '';
      if (!term || term.length < 2) return;

      const encontrados = [];
      for (const [nomeKey, lista] of municipiosPorNome.entries()) {
        if (nomeKey.includes(term)) {
          for (const item of lista) encontrados.push(item);
        }
      }

      if (!encontrados.length) {
        searchResults.innerHTML = '<div style="color:#9ca3af;">Nenhum resultado</div>';
        return;
      }

      encontrados.slice(0, 30).forEach(item => {
        const div = document.createElement('div');
        div.textContent = item.nome;
        div.onclick = () => {
          map.fitBounds(item.bounds, { maxZoom: 11, padding: [30, 30] });
          item.layer.fire('click');
          searchResults.innerHTML = '';
          searchInput.value = '';
        };
        searchResults.appendChild(div);
      });
    });

    // ============================================================
    // ATUALIZA√á√ÉO PERI√ìDICA (opcional)
    // ============================================================
    async function refreshEmployeeData() {
      try {
        const novoIndex = await loadJSON(EMPREGADOS_URL);
        employeeIndexRaw = novoIndex;
        activityByMunicipalityCode = buildMunicipalityActivityIndex(novoIndex);
        if (municipiosLayer) {
          municipiosLayer.setStyle(styleMunicipio);
        }
        console.log('üîÑ √çndice de funcion√°rios atualizado');
      } catch (err) {
        console.error('‚ùå Erro ao atualizar √≠ndice de funcion√°rios:', err);
      }
    }

    // ============================================================
    // INICIAR
    // ============================================================
    init().then(() => {
      // Se quiser atualiza√ß√£o autom√°tica a cada 60 segundos, descomente:
      // setInterval(refreshEmployeeData, 60000);
    });
  </script>
</body>
</html>
